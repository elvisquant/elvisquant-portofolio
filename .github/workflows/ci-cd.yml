name: Build and Push Docker Image

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Still keep fetch-depth: 0 for good measure, but we'll get SHA manually
          fetch-depth: 0 

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Define Docker image tags
        id: set_tags
        run: |
          # --- DEBUGGING OUTPUT ---
          echo "Debug - github.ref: ${{ github.ref }}"
          echo "Debug - github.event_name: ${{ github.event_name }}"
          # --- END DEBUGGING OUTPUT ---

          # Directly get the short SHA using git command
          # This is more robust if github.sha_short is failing
          GIT_SHORT_SHA=$(git rev-parse --short HEAD)
          echo "Debug - GIT_SHORT_SHA from git command: ${GIT_SHORT_SHA}"

          IMAGE_NAME="elvispro1993/elvisquant-portofolio"
          
          # Safety check for empty SHA_SHORT
          if [ -z "${GIT_SHORT_SHA}" ]; then
            echo "Error: GIT_SHORT_SHA is empty after git rev-parse!"
            exit 1
          fi

          # For pushes to main, tag with both the short SHA and latest
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "DOCKER_TAGS=${IMAGE_NAME}:${GIT_SHORT_SHA},${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          else
            # For pull requests or other branches, only use the short SHA tag
            echo "DOCKER_TAGS=${IMAGE_NAME}:${GIT_SHORT_SHA}" >> $GITHUB_OUTPUT
          fi
          
          echo "Final generated tags: ${{ steps.set_tags.outputs.DOCKER_TAGS }}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.set_tags.outputs.DOCKER_TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify pushed image (Optional)
        run: |
          echo "Image pushed successfully. Trying to pull latest tag (if applicable)."
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker pull elvispro1993/elvisquant-portofolio:latest
          fi